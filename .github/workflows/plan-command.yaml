name: plan-command
on:
  repository_dispatch:
    types: [plan-command]
env:
  REGION: us-west-2
jobs:
  terraformPlan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    steps:
      - name: Get the environment name
        id: vars
        run: |
          env=${{ github.event.client_payload.slash_command.args.named.env }}
          if [[ -z "$env" ]]; then exit 1; fi
          echo ::set-output name=env::$env
        continue-on-error: true
      - name: Missing environment name notification
        if: steps.vars.outcome == 'failure'
        uses: peter-evans/create-or-update-comment@v2
        with:
          token: ${{ secrets.SLASH_COMMANDS_PAT }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          comment-id: ${{ github.event.client_payload.github.payload.comment.id }}
          body: |
            > Missing the `env` argument for the `/plan` command
            > Example: /plan env=[test/staging]
          reactions: '-1'
      - name: Missing environment name
        if: steps.vars.outcome == 'failure'
        run: exit 1
      - uses: actions/checkout@v2
        with:
          token: ${{ secrets.SLASH_COMMANDS_PAT }}
          ref: ${{ github.ref }}
      - name: Configure AWS credentials
        id: aws-creds
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_TERRAFORM_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_TERRAFORM_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.REGION }}
      - run: echo ${{ secrets[format('{0}_SECRETS', steps.vars.outputs.env)] }} > ./${{ steps.vars.outputs.env }}.tmp
      - run: base64 -d ./${{ steps.vars.outputs.env }}.tmp > ./terraform/secrets.${{ steps.vars.outputs.env }}.tfvars.json
      - run: rm ./${{ steps.vars.outputs.env }}.tmp
      - uses: actions/setup-python@v4
      - name: Check secrets keys
        id: check_secrets
        run: python scripts/check_secrets.py ${{ steps.vars.outputs.env }}
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.2.2
      - name: Terraform fmt
        id: fmt
        run: terraform fmt -check
        working-directory: terraform
        continue-on-error: true
      - name: Terraform Init
        id: init
        run: |
          terraform init -backend-config="${{ steps.vars.outputs.env }}.tfbackend" -var-file="secrets.${{ steps.vars.outputs.env }}.tfvars.json" -var-file="envvars.${{ steps.vars.outputs.env }}.tfvars.json"
        working-directory: terraform
      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color
        working-directory: terraform
      - uses: terraform-linters/setup-tflint@v2
        name: Setup TFLint
        with:
          tflint_version: v0.39.1
      - name: TFLint
        run: make lint
        working-directory: terraform
      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -no-color -var-file="secrets.${{ steps.vars.outputs.env }}.tfvars.json" -var-file="envvars.${{ steps.vars.outputs.env }}.tfvars.json"
        continue-on-error: true
        working-directory: terraform
      - name: Terraform Plan Output
        uses: peter-evans/create-or-update-comment@v2
        env:
          PLAN: "terraform\n${{ steps.plan.outputs.stdout }}"
        with:
          token: ${{ secrets.SLASH_COMMANDS_PAT }}
          issue-number: ${{ github.event.client_payload.github.payload.issue.number }}
          body: |
            #### Terraform Format and Style ğŸ–Œ `${{ steps.fmt.outcome }}`
            #### Terraform Initialization âš™ï¸ `${{ steps.init.outcome }}`
            #### Terraform Validation ğŸ¤– `${{ steps.validate.outcome }}`
            <details><summary>Validation Output</summary>

            ```
            ${{ steps.validate.outputs.stdout }}
            ```

            </details>

            #### Terraform Plan ğŸ“– `${{ steps.plan.outcome }}`

            <details><summary>Show Plan</summary>

            ```
            ${{ env.PLAN }}
            ```

            </details>
      - name: Terraform Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1
